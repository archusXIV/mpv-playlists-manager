#!/bin/bash

##    GNU GENERAL PUBLIC LICENSE Version 2, June 1991
##    
##    Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
##    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
##    Everyone is permitted to copy and distribute verbatim copies
##    of this license document, but changing it is not allowed.
##
##    Author: Barret E (2021-24) <archus@protonmail.com>
##    https://github.com/archusXIV/mpv-playlists-manager/blob/main/mpm
##    Dependencies: ffmpeg, jq, mpv, yt-dlp.
##    Optionals: fzf, parallel, ueberzug, ranger, w3m, wmctrl, ytfzf
##
##    Youtube-dl is for now kind of unmaintained so install and make a symlink with
##    https://github.com/yt-dlp/yt-dlp/releases
##    sudo pacman -S yt-dlp
##
##    This script rips video urls from Youtube and so on.
##    In our case we use ".m3u" files to store urls in and then be able
##    to watch from the site itself or download videos or just the audio.
##    We can save, remove or edit playlists & mpm config file (mpmrc).
##    It is recommanded to disable mpv cache for better results on direct streaming,
##    or find a better cache parameter.

# shellcheck source=/dev/null
# shellcheck disable=SC2034,SC2044,SC2086,SC2154,SC2120,SC2119,SC2001

trap _CleanTmpDir SIGTERM EXIT

VERSION="v.2.0-1"

CONF_DIR="$HOME/.config/mpm"

[[ ! -d $CONF_DIR ]] && {
    mkdir -p "$CONF_DIR"
    cp /usr/local/share/doc/mpm/{mpmrc,themerc} "$CONF_DIR"
}

MPMRC="$CONF_DIR/mpmrc"
THEMERC="$CONF_DIR/themerc"
. "$MPMRC"
if [[ ! -f $THEMERC && -n $THEME ]]; then
    THEME="default"
    nc=$'\e[0m';
    critical=$'\e[31m';
    info=$'\e[32m';
    mtitle=$'\e[33m';
    task=$'\e[37m';
else
    . "$THEMERC"
    _Theme "$THEME"
fi

## prompts blinking
b=$'\e[5m';
nb=$'\e[25m';

## First source our functions.
for func in $(find /usr/local/lib/mpm/ -name "_*"); do
    . "$func"
done

unset func

# creates a blank line
__() { printf '\n'; }

# global variables
AUDIO_URLS="$tmp_dir/temporaryAudioUrls.m3u"
AUDIO_TITLES="$tmp_dir/temporaryAudioTitles"
CHOOSE1="$tmp_dir/temporarySelection.m3u"
CHOOSE2="$tmp_dir/temporarySelection2.m3u"
DEFAULTITLES="$tmp_dir/DefaultTitles"
DEFAULTM3UTITLES="$titles_dir/default.m3u.titles"
FFOP="$tmp_dir/ffmpeg_output"
HELP="/usr/local/share/doc/mpm/help"
JOBSLIST="$tmp_dir/parallel_list"
NOWPLAYING="$tmp_dir/nowPlaying"
FZFENQUEUE="$tmp_dir/fzfEnqueue.m3u"
QUEUE="$playlists_dir/default.m3u"
SELECTEDTITLES="$tmp_dir/selected.titles"
VIDEO_URLS="$tmp_dir/temporaryVideoUrls.m3u"
VIDEO_TITLES="$tmp_dir/temporaryVideoTitles"
YTSEARCH="$tmp_dir/youtubeSearch"
YTFZFJSON="$tmp_dir/ytfzf.json"
RANGEPROMPT=$(
printf '%s\n' " ${info}Enter numbers separeted by commas or a dash for a range," \
" for example: ${task}1-4,6 8-11 or 1-4,6-8,10 or 2,3,5,6,1 ${info}[${mtitle}C${info}]ancel: ${nc}"
)
SOCKETPATH=$(echo "${mpvGenOptions_SK[*]}" | sed 's/--input-ipc-server=//')

[[ -z $parallel_threads ]] && parallel_threads=4

if [[ ! -e $NOWPLAYING && ${#pids[@]} -gt 1 ]] || \
    [[ -e $NOWPLAYING && ${#pids[@]} -gt 2 ]]; then
    __
    printf '%s\n' " ${critical}mpm_test is already running...${nc}"
    notify-send -t 0 -u critical "mpm_test is already running..."
    exit 1
fi

_LaunchMpm() {
    __
    _Prompt "  Launch mpm_test?" || {
        clear
        exit
    }
    _CheckDependencies "${@}"
}

while true; do

    case "$1" in
        --config |-c) "$MPMEDITOR" "$MPMRC" ;;
        --edit   |-e) _EditPlaylist ;;
        --help   |-h) less "$HELP" ;;
        --load   |-l)
            list="$2".m3u
            cd "$playlists_dir" && {
                if [[ -f $list ]]; then
                    _LoadPlaylistMenu
                else
                    _LoadPlaylist
                fi
            }
        ;;
        --local  |-p) _LoadLocalMenu ;;
        --version|-v) echo " mpm $VERSION" ;;
        *)
            if (( $# == 0 )); then
                _CheckDependencies "${@}"
            else
                __
                printf '%s\n' " ${critical}invalide option: ${task}$1${nc}"
                head -n 11 "$HELP"
                break
            fi
        ;;
    esac

    _LaunchMpm "${@}"

done