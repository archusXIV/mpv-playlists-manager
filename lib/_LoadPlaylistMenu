#!/usr/bin/env bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154,SC2034
_LoadPlaylistMenu() {

    cd "$playlists_dir" || return
    local playlistMenuOptions LIST
    M3UFILE="$list"
    LIST="${list%.*/}" LIST="${LIST//_/ }" LIST="${LIST//.m3u}"

    __testList() {

        [[ $playerTitlesList == "$titles_dir/$list.titles" || -f $tmp_dir/list_tmp ]] && {

            echo -e " ${critical}mpv owns $list playlist...\n"
            read -rsn 1 \
            -p " ${info}[${mtitle}C${info}]ancel download, [Q]uit mpv: ${nc}" testListOptions

            case "$testListOptions" in
                [cC]) _Menu ;;
                [qQ])
                    unset playerTitlesList
                    _KillMpv
                    _Menu
                ;;
                *)
                    _WrongOption "$testListOptions"
                    return
                ;;
            esac

        }

    }

    __testMultiple() (
        [[ -f LoadMultiplePlaylists.m3u ]] && {
            rm {LoadMultiplePlaylists.m3u,"$titles_dir"/loadMultiplePlaylists.m3u.titles}
        }
    )

    _ResizeWindow --main
    clear
    _DownloadMessages --menu

    while :; do
        echo -e "\n ${info}Options for: ${LIST} ${nc}($(_GetLinesList -l) urls)\n\n"
        printf '%s\n' "                                                ${mtitle}::${B}DOWNLOAD/PLAY OPTIONS::${NB}${nc}" \
        "                                           $(_LittleStars)${nc}" \
        "                                  ┌───────────────────────────────────────────────────┐" \
        "                                  │    1) Choose playlist titles & download ${info}audio${nc}     │" \
        "                                  │    2) Choose playlist titles & download ${info}video${nc}     │" \
        "                                  │    3) Download whole playlist as ${info}audio${nc} files      │" \
        "                                  │    4) Download whole playlist as ${info}video${nc} files      │" \
        "                                  │    5) Choose playlist titles & play ${info}audio/video${nc}   │" \
        "                                  │    6) Schedule download                           │" \
        "                                  │    7) Test URLs from current playlist             │" \
        "                                  │    8) Back to main menu                           │" \
        "                                  └───────────────────────────────────────────────────┘" \
        "                                                   ${info}${b}Select an option${nb}${nc}"

        read -rsn 1 loadPlaylistMenuOptions

        case "$loadPlaylistMenuOptions" in
            1) __testList; _ChooseDownloadAudio ;;
            2) __testList; _ChooseDownloadVideo ;;
            3) __testList; _GetAudio -l ;;
            4) __testList; _CheckParallelDownloads --before; _DownloadVideoList ;;
            5) _MpvOwnsTmpList --collection || _ChooseFromPlay ;;
            6) _ScheduleDownload ;;
            7) _TestUrlsFromCurrentPlaylist ;;
            [bB8]) __testMultiple; _Menu ;;
            [rR]) continue ;;
            *) _WrongOption "$loadPlaylistMenuOptions"; __testMultiple; _Menu ;;
        esac

    done

}
