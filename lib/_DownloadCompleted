#!/usr/bin/env bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154
_DownloadCompleted() {

    cd "$playlists_dir" || exit 1
    _IfPartsExist
    [[ -f $SELECTED_TITLES ]] && _UpdateSelected --selection

    clear
    echo "$M3UFILE, $TITLES"; sleep 3
    declare -a FILES=(
        "$list" "$list"_origin
        "$titles_dir/$list.titles" "$titles_dir/$list.titles_origin"
        "$SELECTED_URLS1" "$SELECTED_URLS2"
        "$SELECTED_TITLES" "$SELECTED_TITLES"_orgin
        "$tmp_dir/list_tmp"
    )

    [[ -f $tmp_dir/multipleFilesTitles_origin ]] && {
        FILES+=("$tmp_dir/multipleFilesTitles_origin")
        FILES+=("$tmp_dir/multipleFilesTitles")
        FILES+=("$tmp_dir/loadMultiplePlaylists.m3u_origin")
        FILES+=("$tmp_dir/loadMultiplePlaylists.m3u")
    }

    if (($(_GetLinesList -l) > 0)); then
        if [[ $keep_none_empty_playlist == yes ]]; then
            unset {FILES[0],FILES[2]}
            rm -f "${FILES[@]}" >/dev/null 2>&1
        else
            echo -e " ${critical}keep_none_empty_playlist is set to 'no'.${nc}\n"
            _Prompt \
            " ${info}Downloads are completed but ${list##*/} is not empty, do you want to KEEP it?:${nc}" || {
                rm -f "${FILES[@]}" >/dev/null 2>&1
                _PolybarIpc
                printf '%s\n' " ${critical}${list##*/} removed...${nc}"
                sleep 3
            }
            unset {FILES[0],FILES[2]}
            rm -f "${FILES[@]}" >/dev/null 2>&1
        fi
    else
        _BlankLine
        if [[ ! -s $list ]]; then
            printf '%s\n' " ${info}Downloads completed." \
            " ${critical}${list##*/} is empty... ${list##*/} removed.${nc}"
            rm -f "${FILES[@]}" >/dev/null 2>&1
            sleep 3
        fi
    fi

    _PolybarIpc
    _CheckParallelDownloads --after
    _IfQuitAfterTask -d

}

