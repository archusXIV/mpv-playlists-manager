#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154
_SearchYoutubeWithFzf() {

    local sanitizedRequest sanitizedResult grabLink grabPlaylist IDS id \
    mediaLinkIDS mediaPrefix playlistLinkIDS playlistPrefix playlistName
    __
    read -rp " ${info}Search for youtube ${Type} (no quotes): ${nc}" request

    [[ -z $request ]] && return

    sanitizedRequest=$(
        sed -e '
        s/+/%2B/g;s/#/%23/g;s/&/%26/g;s/\s/+/g
        ' <<< "$request"
    )

    sanitizedResult=$(
        curl \
        -s "https://www.youtube.com/results?search_query=${sanitizedRequest}" | \
        sed 's/\\.//g'
    )

    if ! grep -q "$sanitizedRequest" <<< "$sanitizedResult"; then
        echo "unable to reach youtube.com"
        sleep 2s
        return
    fi

    grabLink='"videoRenderer":{"videoId":"\K.{11}".+?"text":".+?[^\\](?=")'
    grabPlaylist='"playlistRenderer":{"playlistId":"\K.{34}?","title":{"simpleText":".+?[^\"](?=")'

    __getResults() (
        grep -oP "$1" <<< "$sanitizedResult" | \
        awk -F\" -v p="$2" '{ print $1 "\t" p " " $NF}'
    )

    mediaLinkIDS=$(__getResults "$grabLink" "[${Type}]")
    playlistLinkIDS=$(__getResults "$grabPlaylist" "[Playlist]")

    [[ -n $playlistLinkIDS ]] && IDS="$playlistLinkIDS\n"
    [[ -n $mediaLinkIDS ]] && IDS="$IDS$mediaLinkIDS"

    mediaPrefix="https://www.youtube.com/watch?v="
    playlistPrefix="https://www.youtube.com/playlist?list="

    echo -e "$IDS" | cut -d'	' -f2 \
    | fzf -m \
    --prompt='Filter: ' \
    --header "${info}${b}"'Select with Tab, Enter to confirm: '"${nb}${nc}" \
    --border rounded \
    --reverse \
    | sed 's/\[.*]\s//' > "$TITLES"_tmp
    clear
    __
    printf '%s\n' " ${info}Links added to $Type list, please wait...${nc}"
    
    while read -r line; do

        # grep a fixed string that is a word and matches only one line in selection.
        id=$(echo -e "$IDS" | grep -Fwm1 "$line" | cut -d'	' -f1)

        playlistName=$(
            yt-dlp "${ytdlPreset_DW[@]}" \
            -J --flat-playlist "$playlistPrefix$id" 2>/dev/null \
            | jq --raw-output .title
        )

        case "$id" in
            # 11 characters id = media
            ???????????)
                echo "$mediaPrefix$id" | tee -a "$URLS" >> "$QUEUE"
                echo -e "$line" \
                | sed "/${playlistName}/d" \
                | tee -a "$TITLES" >> "$DEFAULTITLES"
                _RemoveCrap
            ;;
            # 34 characters id = playlist
            ??????????????????????????????????)
                echo "$playlistPrefix$id" >> "$YTSEARCH"
                _RemoveCrap
            ;;
        esac

    done < "$TITLES"_tmp

    rm "$TITLES"_tmp

}