#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2013,SC2154,SC2076
_GetVideo() {

    local getVideoCounter M3UFILE TITLES

    case "$1" in
        -q)
            __
            if [[ ! -f $DEFAULTITLES && \
                -f $DEFAULTM3UTITLES ]]; then
                cat "$DEFAULTM3UTITLES" > \
                "$DEFAULTITLES"
            elif [[ -f $DEFAULTITLES ]]; then
                printf '%s\n' " ${info}Fetching titles file...${nc}"
                sleep 1
            else
                printf '%s\n' " ${info}Getting titles...${nc}"
                _GetMediaTitle -q > "$DEFAULTITLES"
                clear
            fi
            M3UFILE="$QUEUE"
            TITLES="$DEFAULTITLES"
        ;;
        -v)
            __
            [[ $(_GetLinesList -v) -eq 0 ]] && {
                echo " ${critical}No links in the list${nc}"
                sleep 2
                _CopyVideo
            }
            M3UFILE="$VIDEO_URLS"
            TITLES="$VIDEO_TITLES"
        ;;
    esac

    cp -f "$M3UFILE" "$M3UFILE"_origin
    cp -f "$TITLES" "$TITLES"_origin
    clear
    
    getVideoCounter=$(grep -c '^https' "$M3UFILE")

    __ChooseFormatMessages() (
        [[ $M3UFILE = "$QUEUE" ]] && {
            printf '%s\n' " ${info}Choose a format code for $(_GetLinkTitle -q)." \
            " eg: 137+251 (video+audio), hls-1080p, 22 for single:${nc}"
        }
        [[ $M3UFILE = "$VIDEO_URLS" ]] && {
            printf '%s\n' " ${info}Choose a format code for $(_GetLinkTitle -v)." \
            " eg: 137+251 (video+audio), hls-1080p, 22 for single:${nc}"
        }
    )

    __DownloadMessages() (
        [[ $TITLES = "$DEFAULTITLES" ]] && {
            printf '%s\n' " ${info}$getVideoCounter video file(s) left to download." \
            " Please be patient while downloading:  $(_GetLinkTitle -q).webm${nc}"
        }
        [[ $TITLES = "$VIDEO_TITLES" ]] && {
            printf '%s\n' " ${info}$getVideoCounter video file(s) left to download." \
            " Please be patient while downloading:  $(_GetLinkTitle -v).webm${nc}"
        }
    )

    cd "$videos_dir" || exit 1

    for getVideoUrl in $(grep '^https' "$M3UFILE"); do
        __
        youtube-dl -F "${ytdlPreset_DW[@]}" "$getVideoUrl"
        __
        __ChooseFormatMessages
        read -r code
        clear
        __
        if [[ "$code" =~ '+' ]]; then

            __DownloadMessages
            # downloader presets described in ~/.config/mpm/mpmrc
            youtube-dl \
            -f "$code" \
            "${ytdlPreset_X[@]}" "$getVideoUrl"

        else

            __DownloadMessages
            youtube-dl \
            -f "$code" \
            "${ytdlPreset_NC[@]}" "$getVideoUrl"
        
        fi

        if [[ $M3UFILE = "$VIDEO_URLS" ]]; then
            sed -i '1d' {"$M3UFILE","$TITLES"}
            clear
        else
            sed -i '2d' "$M3UFILE"
            sed -i '1d' "$TITLES"
            clear
        fi

        ((getVideoCounter--))

    done

    echo -e " ${info}Done.\n${nc}"
    sleep 2
    _GetCompleted -v

}
