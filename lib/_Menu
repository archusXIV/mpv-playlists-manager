#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154
_Menu() {

    cd "$main_dir" || exit 1

    while [[ -e $QUEUE ]]; do
        _ResizeWindow
        clear
        __
        echo -e "                                           ${mtitle}::MPV-PLAYLISTS-MANAGER $VERSION::" "$(_CheckUpdate)"
        echo -e "                                          $(_LittleStars)"
        echo -e "                                        ${info}current theme: $THEME. ${critical}For usage type U${nc}"
        _ListsCount
        echo -e "                  ┌─────────────────────────────────────────────────────────────────────────────────────┐"
        echo -e "                  │                      GENERAL OPTIONS                       │     ${mtitle}MPMRC SETTINGS${nc}     │"
        echo -e "                  └─────────────────────────────────────────────────────────────────────────────────────┘"
        echo -e "                  ┌─────────────────────────────────────────────────────────────────────────────────────┐"
        [[ $use_parallel = yes ]] && echo -e "                  │  1) Create/Add video playlist   6) View default playlist   │  use parallel:    ${task}yes${nc}  │" || \
        echo -e "                  │  1) Create/Add video playlist   6) View default playlist   │  use parallel:     ${task}no${nc}  │"
        [[ $direct_download = yes ]] && echo -e "                  │  2) Create/Add audio playlist   7) Clear all tmp lists     │  direct download: ${task}$direct_download${nc}  │"
        [[ $direct_download = no ]] && echo -e "                  │  2) Create/Add audio playlist   7) Clear all tmp lists     │  direct download:  ${task}$direct_download${nc}  │"
        [[ $automatic_audio_conversion = yes ]] && echo -e "                  │  3) Save as/Delete a playlist   8) Edit a playlist         │  conversion auto: ${task}$automatic_audio_conversion${nc}  │"
        [[ $automatic_audio_conversion = no ]] && echo -e "                  │  3) Save as/Delete a playlist   8) Edit a playlist         │  conversion auto:  ${task}$automatic_audio_conversion${nc}  │"
        if [[ -z $default_conversion_format ]]; then echo -e "                  │  4) Play/Download a playlist    ${mtitle}9)${nc} Edit mpm config (mpmrc) │  audio format:  ${task}unset${nc}  │"; \
        elif [[ $default_conversion_format != flac ]]; then echo -e "                  │  4) Play/Download a playlist    ${mtitle}9)${nc} Edit mpm config (mpmrc) │  audio format:    ${task}$default_conversion_format${nc}  │"; \
        elif [[ $default_conversion_format = flac ]]; then echo -e "                  │  4) Play/Download a playlist    ${mtitle}9)${nc} Edit mpm config (mpmrc) │  audio format:   ${task}$default_conversion_format${nc}  │"; fi
        [[ $quit_after_task = yes ]] && echo -e "                  │  5) Load local folder/files     X) Exit                    │  quit after task: ${task}$quit_after_task${nc}  │"
        [[ $quit_after_task = no ]] && echo -e "                  │  5) Load local folder/files     X) Exit                    │  quit after task:  ${task}$quit_after_task${nc}  │"
        echo -e "                  └─────────────────────────────────────────────────────────────────────────────────────┘"
        _IfMpvc
        [[ -f $tmp_dir/1 ]] \
            && echo -e "                                                     ${info}Select an item${nc}" \
            || echo -e "                                                     ${info}${b}Select an item${nc}${nb}"
        __
        read -rsn 1 mainMenuOptions
        case "$mainMenuOptions" in
            1)  _CopyUrl -v
                __  ;;
            2)  _CopyUrl -a
                __  ;;
            3)  _SaveRemove
                __  ;;
            4)  _LoadPlaylist
                __  ;;
            5)  _LoadLocal
                __  ;;
            6)  _ViewUrlInfo -q
                __  ;;
            7)  _DeleteUrls
                __  ;;
            8)  _EditPlaylist
                __  ;;
            9)  _EditMpmConf
                __  ;;
            n|N)
                if [[ $use_mpvc = yes ]] && [[ -n $mpvc_tui ]]; then
                    "$mpvc_tui"
                else
                    printf '%s\n' " ${critical}No mpv interface setup in your config..." \
                    " use_mpvc must be set to 'yes' or mpvc_tui is empty${nc}"
                    sleep 5
                    continue
                fi
            ;;
            q|Q)
                pgrep -x mpv >/dev/null && {
                    kill -SIGTERM "$(pidof mpv)"
                    rm "$tmp_dir"/{nowPlaying,temporary*} 2>/dev/null
                }
                ;;
            u|U)
                less "$HELP"
            ;;
            x|X)
                __;__
                if [[ -s "$AUDIO_URLS" || -s "$VIDEO_URLS" ]]; then
                    _SaveOnExit
                else
                    nc=$'\e[0m';
                    echo "${nc}"
                    clear
                    exit 0
                fi
            ;;

            z|Z)
                # we now exit the subshell not the program
                pgrep -x mpv >/dev/null && {
                    kill -SIGTERM "$(pidof mpv)"
                    exit 0
                }
            ;;
            *)
                __
                printf '%s\n' " ${critical}Wrong option $mainMenuOptions...${nc}"
                sleep 3s && continue
            ;;
        esac
    done
}