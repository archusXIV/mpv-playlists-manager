#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2013,SC2076,SC2154
_ChooseDownloadVideo() {
    cd "$playlists_dir" || exit 1

    clear
    _TitlesListCompare

    cp -f "$list" "$list"_origin 2>/dev/null

    __ChooseDirectVideoDownload() (
        for i in "${array[@]}"; do
            ((i++))
            url=$(sed -n "${i}p" "$playlists_dir"/"$list")
            echo "$url" >> "$CHOOSE1"
        done

        clear

        mapfile -t DIRECT < <(grep '^https' "$CHOOSE1")

        for line in "${DIRECT[@]}"; do
            if [[ $direct_download = yes ]]; then
                printf '%s\n' " ${task}Direct download enabled.${nc}"
            else
                printf '%s\n' " ${task}Download method = direct.${nc}"
            fi
            __
            printf '%s\n' " ${info}Downloading $counter file(s).${nc}"
            if [[ $line =~ 'youtube.com' ]]; then
                youtube-dl \
                --no-warnings \
                --merge-output-format mp4 \
                --progress "$line"
                clear
            else
                youtube-dl --no-warnings --progress "$line"
                clear
            fi
            ((counter--))
        done

        echo " ${info}All done${nc}"
        sleep 2
    )

    IFS=","; read -ra array \
    -p " Enter links numbers separeted by comma, eg: 3,1,5: "

    clear
    cd "$videos_dir" || exit 1

    local counter="${#array[*]}"

    if [[ $direct_download = yes ]]; then
        __ChooseDirectVideoDownload
    else
        __
        printf '%s\n' " ${info}Tip: direct download will always pick the best format," \
        " on Youtube webm may be the best one but we'll merge files in mp4." \
        " Choose [S]pecific codes or [D]irect download?:\n${nc}"
        sleep 0.5 && read -rsn 1 choice
    fi

    case "$choice" in
        d|D)
            __ChooseDirectVideoDownload
        ;;
        s|S)
            for i in "${array[@]}"; do
                ((i++))
                url=$(sed -n "${i}p" "$playlists_dir"/"$list")
                echo "$url" >> "$CHOOSE1"

                if [[ $url =~ 'youtube.com' ]]; then
                    __
                    youtube-dl -F --no-warnings "$url" \
                    | sed '1,5d;/^[sb]/d;/^\s*$/d;s/-//g;/^\s*$/d'
                else
                    youtube-dl -F --no-warnings "$url"
                fi
                __
                printf '%s\n' " ${info}Choose a format code." \
                " eg: 137+251 for merging, hls-1080p, 22 for single:${nc}"
                read -r code
                sleep 0.5
                clear
                printf '%s\n' " ${info}Total downloads: $counter${nc}"
                if [[ $code =~ '+' ]]; then
                    youtube-dl -f "$code" \
                    --no-warnings \
                    --merge-output-format mp4 \
                    --progress "$url"
                else
                    youtube-dl -f "$code" \
                    --no-warnings --progress "$url"
                fi
                ((counter--))
                clear
            done
            echo " ${info}All done${nc}"
            sleep 2
        ;;
    esac

    cd "$playlists_dir" || exit 1
    # let's remove downloaded links from the original file
    # and sending the other ones in a second temporary file...
    for line in $(grep '^https' "$CHOOSE1"); do
        grep -v "${line}" "$list" >> "$CHOOSE2"
    done

    # ...that we now rename with the original file name.
    mv -f "$CHOOSE2" "$list"
    rm "$CHOOSE1"

    # if we don't unset IFS other functions will be messed up!
    unset IFS

    echo -e " ${task}Updating titles...${b}please wait.${nb}${nc}\n"
    _GetMediaTitle -l > "$titles_dir"/"$list".titles
    clear
    _DownloadCompleted

}

