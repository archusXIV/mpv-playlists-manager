#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154
_CheckDependencies() {
    ## Checking dependencies: softwares, directories and files.
    declare -a deps=( "ffmpeg" "jq" "mpv" "vim" "youtube-dl" "yt-dlp" \
                    "ueberzug" "wmctrl" "w3m" )

    for dep in "${deps[@]:0:6}"; do
        [[ -z $(command -v "$dep") ]] && {
            printf '%s\n' " ${critical}$dep isn 't installed, bye..."
            exit 127
        }
    done

    for optional in "${deps[@]:6:9}"; do
        [[ -z $(command -v "$optional") ]] && {
            printf '%s\n' " ${info}For better experience consider installing $optional.${nc}"
            sleep 2s
        }
    done

    [[ ! -f ~/.config/mpm/mpmrc ]] && {
        mkdir -p ~/.config/mpm
        cp /usr/local/share/doc/mpm/mpmrc ~/.config/mpm/mpmrc
    }

    # shellcheck source=/dev/null
    ## summon our personal settings
    source ~/.config/mpm/mpmrc

    [[ -z $MPMEDITOR ]] && {
        printf '%s\n' " ${critical}The config EDITOR is not set...exiting!${nc}"
        notify-send -t 0 -u critical "The config EDITOR is not set...exiting!"
        exit 1
    }

    [[ -z $(command -v "$FILEMANAGER") ]] && {
        printf '%s\n' " ${critical}Consider installing a terminal file manager.${nc}"
        sleep 3s
    }

    if [[ ! -d $main_dir ]]; then
        mkdir --parents \
        {"$audios_dir","$playlists_dir","$titles_dir","$tmp_dir","$videos_dir"}
    else
        [[ ! -d $audios_dir ]] && mkdir -p "$audios_dir"
        [[ ! -d $playlists_dir ]] && mkdir -p "$playlists_dir"
        [[ ! -d $titles_dir ]] && mkdir -p "$titles_dir"
        [[ ! -d $tmp_dir ]] && mkdir -p "$tmp_dir"
        [[ ! -d $videos_dir ]] && mkdir -p "$videos_dir"
    fi

    [[ ! -f $QUEUE ]] && echo "#EXTM3U" > "$QUEUE"

    (($(_GetLinesList -q) >= 1)) && touch "$tmp_dir"/1

    _Menu

}
