#!/usr/bin/env bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154,SC2034
_SelectLocalFiles() {

    local dir files localDirPath selected_files
    dir="$1"
    localDirPath=$(pwd | sed 's,/,\\/,g')
    cd "$dir" || return

    if [[ $localMediaType == "radio" ]]; then
        mapfile -t files < <(find . -type f -printf '%f\n' | sort -d)
    else
        files=()
        while read -r -d '' f; do
            if file --mime-type "$f" | grep -qE "[aA]udio|[vV]ideo"; then
                files+=("${f#./}")
            fi
        done < <(find . -maxdepth 1 -type f -print0)
        # Sort the files array using bash's built-in sort
        mapfile -t files < <(printf '%s\n' "${files[@]}" | sort)
    fi

    if (( ${#files[@]} == 0 )); then
        printf '%s\n' " ${critical}No supported files found in $dir${nc}"
        sleep 3
        return
    fi

    local page_size current_page total_pages start end input
    page_size=25
    current_page=1
    total_pages=$(( (${#files[@]} + page_size - 1) / page_size ))

    __cleanup() {
        unset IFS input files
        rm manualEnqueue.m3u 2>/dev/null
    }

    while :; do
        start=$(( (current_page - 1) * page_size ))
        end=$(( start + page_size - 1 ))
        if (( end >= ${#files[@]} )); then end=$(( ${#files[@]} - 1 )); fi

        clear
        _BlankLine
        printf '%s\n' " ${info}Available files in ${dir##*/} (Page $current_page/$total_pages):${nc}"
        _BlankLine
        for ((i=start;i<=end;i++)); do
            printf '%s\n' "  $((i+1))) ${files[i]}"
        done

        declare -a selectPrompt=(
            "${info}Enter numbers separated by commas (e.g: 1,3,5) or"
            "[A]ll,"
            "[N]ext page,"
            "[P]rev page,"
            "[D]one,"
            "[${mtitle}C${info}]ancel: ${nc}"
        )

        _BlankLine
        ((${#files[@]} <= 25)) && unset 'selectPrompt[2]' 'selectPrompt[3]'
        # ((${#files[@]} < 25)) && selectPrompt=("${selectPrompt[@]:0:2}" "${selectPrompt[@]:4}")
        read -rp " ${selectPrompt[*]}" input
        case "$input" in
            [aA]) selected_files=("${files[@]}"); break ;;
            [dD]) selection="$input"; break ;;
            [cC])
                __cleanup
                printf '\n%s\n' " ${critical}Operation cancelled.${nc}"
                sleep 2
                return
            ;;
            [nN]) if (( current_page < total_pages )); then ((current_page++)); continue; fi ;;
            [pP]) if (( current_page > 1 )); then ((current_page--)); continue; fi ;;
            *[!0-9])
                __cleanup
                printf '\n%s\n' " ${critical}Error: Please enter valid numbers.${nc}" >&2
                sleep 2
                return 1
            ;;
            *)
                selection="$input"
                IFS=','; read -ra nums <<< "$selection"
                for num in "${nums[@]}"; do
                    num=$((num - 1))
                    if (( num >= 0 && num < ${#files[@]} )); then
                        selected_files+=("${files[num]}")
                    fi
                done
                # if we don't unset IFS to the default, the next prompt will be messed up
                unset IFS
                if (( current_page < total_pages )); then
                    ((current_page++))
                    continue
                else
                    # we've reached the last page
                    break
                fi
            ;;
        esac
    done

    if (( ${#selected_files[@]} == 0 )) || [[ -z $input ]]; then
        __cleanup
        printf '\n%s\n' " ${critical}No valid selections or operation cancelled.${nc}"
        sleep 3
        return
    fi

    printf '%s\n' "${selected_files[@]}" > manualEnqueue.m3u
    unset IFS input files
    _SelectLocalFilesOptions

}
