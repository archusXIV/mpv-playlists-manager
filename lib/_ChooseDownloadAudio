#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154,SC2143,SC2076,SC2034,SC1001,SC2181
_ChooseDownloadAudio() {

    cd "$playlists_dir" || exit 1

    local counter M3UFILE animationTitles mediaDir
    
    clear
    _TitlesListCompare -l
    _GetRange

    clear
    cp -f "$list" "$list"_origin
    cp -f "$SELECTEDTITLES" "$SELECTEDTITLES"_orgin

    mkdir --parents "$audios_dir"/"${list%.*}"
    mediaDir="$audios_dir"/"${list%.*}"

    cd "$mediaDir" || {
        printf '%s\n' \
        " ${critical}Failed to access audio directory.${nc}"
        sleep 4
        _Menu
    }

    M3UFILE="$CHOOSE1"
    readarray -t SELECTEDAUDIO < "$M3UFILE"
    counter="${#SELECTEDAUDIO[@]}"
    
    __chooseDownloadAudioFormat() (
        __
        printf '%s\n' " ${info}Choose a format code for: $(_GetLinkTitle -s)${nc}"
        read -r code
        clear
        _DownloadMessages --choose-audio
        if [[ $(_GetLinkTitle -s) =~ '/' ]]; then
            yt-dlp --format "$code" "${ytdlPreset_NC[@]}" "$url"
        else
            yt-dlp --output "$(_GetLinkTitle -s).%(ext)s" \
            --format "$code" "${ytdlPreset_NC[@]}" "$url"
        fi
    )

    _ParallelDownloadCmd --download

    if [[ $? = 0 ]]; then
        animationTitles="$SELECTEDTITLES"
        _ParallelDownloadCmd --choose-audio
        _DownloadMessages --choose-audio
        _ParallelAnimation
    else
        for url in "${SELECTEDAUDIO[@]}"; do

            if [[ $direct_download = yes ]] && \
                [[ $(yt-dlp -F "${ytdlPreset_DW[@]}" "$url" \
                | grep '^251') ]]; then

                _DownloadMessages --choose-audio

                if [[ $(_GetLinkTitle -s) =~ '/' ]]; then
                    yt-dlp --format 251 "${ytdlPreset_NC[@]}" "$url"
                else
                    yt-dlp --output "$(_GetLinkTitle -s).%(ext)s" \
                    --format 251 "${ytdlPreset_NC[@]}" "$url"
                fi

            elif [[ $direct_download = no ]] && [[ $url =~ 'youtube.com' ]]; then
                __
                yt-dlp -F "${ytdlPreset_DW[@]}" "$url" \
                | awk '/audio only|PROTO|^[-]/ {sub("^[sb*]",""); print $0}'
                __chooseDownloadAudioFormat
            else
                yt-dlp -F "${ytdlPreset_DW[@]}" "$url"
                __chooseDownloadAudioFormat
            fi

            sed -i '1d' "$SELECTEDTITLES"
            ((counter--))
            clear

        done
    fi

    unset url

    _UpdateSelected -u
    clear
    echo -e " ${info}Done${nc}\n"
    sleep 2
    _IfWebmFiles
}