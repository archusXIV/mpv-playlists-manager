#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2013,SC2154,SC2143,SC2076
_ChooseDownloadAudio() {
    cd "$playlists_dir" || exit 1
    clear
    _TitlesListCompare

    cp -f "$list" "$list"_origin
    mkdir -p "$audios_dir"/"${list%.*}"

    IFS=","
    read -ra array \
    -p " ${info}Enter links numbers separeted by comma, eg: 3,1,5: ${nc}"

    clear
    cd "$audios_dir"/"${list%.*}" || exit 1

    local chooseAudioCounter
    chooseAudioCounter="${#array[*]}"

    _GetSelected

    mapfile -t SELECTEDAUDIO < <(grep '^https' "$CHOOSE1")

    for url in "${SELECTEDAUDIO[@]}"; do

        if [[ $direct_download = yes ]] && \
            [[ $(youtube-dl -F "${ytdlPreset_DW[@]}" "$url" \
            | grep '^251') ]]; then

            printf '%s\n' " ${task}Direct download enabled.${nc}"
            __
            printf '%s\n' " ${info}$chooseAudioCounter file(s) left to downloads." \
            " Downloading: $(_GetLinkTitle -s)${nc}"
            youtube-dl --output "$(_GetLinkTitle -s).%(ext)s" \
            --format 251 "${ytdlPreset_NC[@]}" "$url"

        elif [[ $direct_download = no ]] && [[ $url =~ 'youtube.com' ]]; then
            __
            printf '%s\n' " ${task}Direct download disabled.${nc}"
            __
            youtube-dl -F "${ytdlPreset_DW[@]}" "$url" \
            | awk '/audio only|PROTO|^[-]/ {sub("^[sb*]",""); print $0}'
            __
            printf '%s\n' " ${info}Choose a format code for: $(_GetLinkTitle -s)${nc}"
            read -r code
            clear
            __
            printf '%s\n' " ${info}$chooseAudioCounter file(s) left to downloads." \
            " Downloading: $(_GetLinkTitle -s)${nc}"
            youtube-dl --output "$(_GetLinkTitle -s).%(ext)s" \
            --format "$code" "${ytdlPreset_NC[@]}" "$url"

        else

            youtube-dl -F "${ytdlPreset_DW[@]}" "$url"
            printf '%s\n' " ${info}Choose a format code for: $(_GetLinkTitle -s)${nc}"
            read -r code
            clear
            __
            printf '%s\n' " ${info}$chooseAudioCounter file(s) left to downloads.${nc}"
            sleep 0.5
            youtube-dl --output "$(_GetLinkTitle -s).%(ext)s" \
            --format "$code" "${ytdlPreset_NC[@]}" "$url"

        fi

        sed -i '1d' "$SELECTEDTITLES"
        ((chooseAudioCounter--))
        clear

    done

    _UpdateSelected

    # if we don't unset IFS other functions will be messed up!
    unset IFS

    clear

    echo -e " ${info}Done${nc}\n"

    clear

    cd "$audios_dir"/"${list%.*}" || exit 1

    if [[ -n $(find "$audios_dir"/"${list%.*}" -iname "*.webm") ]]; then

        echo " ${critical}ADVISORY: if you choose conversion, all downloaded webm"
        echo -e " files will be converted in the chosen format.${nc}\n"
        find . -iname "*.webm" | sed 's,.*/,,'

        if [[ $automatic_audio_conversion = yes ]]; then
            __
            printf '%s\n' " ${task}Automatic audio conversion enabled.${nc}"
            sleep 2
            _ConvertAudio && _DownloadCompleted
        else
            __
            _Prompt " ${info}Do you wish to convert them?: ${nc}" || {
                _DownloadCompleted
            }
            _ConvertAudio && _DownloadCompleted
        fi

    else
        _DownloadCompleted
    fi

}
