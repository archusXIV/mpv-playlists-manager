#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154,SC2086
_Remove() {

    cd "$tmp_dir" || exit 1

    __removeTmpLinks() (
        clear
        __
        cat -n "$tmpTitles"
        removeRange=$(printf '%s\n' "Enter numbers separeted by commas or a dash for a range" \
        " for example: ${task}1-4,6 8-11 or 1-4,6-8,10 or 2,3,5,6,1 : ${nc}")
        __
        IFS=", "; read -ra array -p " ${info}""$removeRange""${nc}"

        for range in "${array[@]}"; do
            IFS="-"; read -r start end <<< "$range"
            [[ -z $start ]] && continue
            [[ -z $end ]] && end="$start"
            for ((i=start;i <= end;i++)); do
                sed -n "${i}p" "$tmpList" >> "$tmpList"_tmp
                sed -n "${i}p" "$tmpTitles" >> "$tmpTitles"_tmp
            done
        done

        grep -v "$(grep '^https' "$tmpList"_tmp)" "$tmpList" \
        >> "$tmpList"_tmp2 && mv -f "$tmpList"_tmp2 "$tmpList"

        grep -v "$(grep '^[[:print:]]' "$tmpTitles"_tmp)" "$tmpTitles" \
        >> "$tmpTitles"_tmp2 && mv -f "$tmpTitles"_tmp2 "$tmpTitles"

        rm {"$tmpList"_tmp,"$tmpTitles"_tmp}

        printf '%s\n' " ${critical}Selected links removed...${nc}"
        unset IFS
        sleep 3

    )

    __removeWarning() (
        pgrep -x mpv >/dev/null && \
        __
        printf '%s\n' " ${critical}$tmpList is owned by mpv...retry later.${nc}"
        sleep 4
    )

    case "$1" in
        -a)
            tmpList="$AUDIO_URLS"
            tmpTitles="$AUDIO_TITLES"
            __
            read -rsn 1 -p " ${info}Remove [L]inks or the [W]hole $Type list?: ${nc}"
            [[ $(awk -F"/" '{print $NF}' "$tmp_dir"/nowPlaying 2>/dev/null) =~ Audio ]] && {
                __removeWarning
                return
            }
            
            if [[ $REPLY =~ l|L ]]; then
                __removeTmpLinks
                _ViewUrlInfo -a
            else
                rm -f {"$tmpList","$tmpTitles"} \
                {"$tmpList"_origin,"$tmpTitles"_origin}
                rm -rf "$HOME"/.parallel 2>/dev/null
                __
                echo " ${critical}$Type list removed...${nc}"
            fi
        ;;
        -q)
            tmpList="$QUEUE"
            tmpTitles="$DEFAULTITLES"
            __
            read -rsn 1 -p " ${info}Remove [L]inks or the [W]hole default list?: ${nc}"
            [[ $(awk -F"/" '{print $NF}' "$tmp_dir"/nowPlaying 2>/dev/null) =~ default ]] && {
                __removeWarning
                _ViewUrlInfo -q
            }
            if [[ $REPLY =~ l|L ]]; then
                sed -i '1d' "$tmpList"
                __removeTmpLinks
                sed -i '1s/^/#EXTM3U\n/' "$tmpList"
                _ViewUrlInfo -q
            else
                sed -i '/^[[:alpha:]]/d' "$tmpList"
                rm -f \
                {"$tmpList"_origin,"$tmp_dir"/1,"$DEFAULTITLES"{,_origin},"$DEFAULTM3UTITLES"} 2>/dev/null
                rm -rf "$HOME"/.parallel 2>/dev/null
                __
                echo " ${critical}Default list cleared...${nc}"
            fi
        ;;
        -v)
            tmpList="$VIDEO_URLS"
            tmpTitles="$VIDEO_TITLES"
            __
            read -rsn 1 -p " ${info}Remove [L]inks or the [W]hole $Type list?: ${nc}"
            [[ $(awk -F"/" '{print $NF}' "$tmp_dir"/nowPlaying 2>/dev/null) =~ Video ]] && {
                __removeWarning
                return
            }
            if [[ $REPLY =~ l|L ]]; then
                __removeTmpLinks
                _ViewUrlInfo -v
            else
                rm -f {"$tmpList","$tmpTitles"} \
                {"$tmpList"_origin,"$tmpTitles"_origin}
                __
                echo " ${critical}$Type list removed...${nc}"
            fi
        ;;
    esac

    sleep 3
    _Menu

}