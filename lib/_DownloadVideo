#!/bin/bash
## This is a part of main script: mpm.

_DownloadVideo() {

    cd "$videos_dir"
    clear
    cp -f "$list" "$list"_origin 2>/dev/null
    _CheckCode -l

    __
    echo " ${green}Tip: direct download will always pick the best format,"
    echo -e " on Youtube webm may be the best one but we'll merge files in mp4.\n"
    echo -e " Choose [S]pecific codes or [D]irect download?:\n${nocolor}"
    read -rsn 1 choice

    case "$choice" in
        d|D)    mapfile -t DIRECT < <(grep -v '#EXTM3U' "$list")

                count=$(grep -v -c '#EXTM3U' "$list")

                for line in "${DIRECT[@]}"; do
                    printf '%s\n' " ${green}Downloading $count file(s).${nocolor}"
                    [[ $line =~ 'youtube.com' ]] && {
                        youtube-dl --no-warnings --merge-output-format mp4 "$line"
                        clear
                    } || youtube-dl --no-warnings "$line" && clear
                    let "count--"
                done

                echo " ${green}All done${nocolor}"
                sleep 2
                _DownloadCompleted
        ;;
        s|S)    for url in $(grep -e 'https' "$list"); do

                    if (( $(_GetLinesList -l) < 3 )); then
                        __
                        echo " ${green}There is $(_GetLinesList -l) video file left to download.${nocolor}"
                    else
                        __
                        echo " ${green}There are $(_GetLinesList -l) video files left to download.${nocolor}"
                    fi

                    echo -e " ${green}Codes for: $(_GetLinkTitle -d).${nocolor}\n"

                    if [[ $url =~ 'youtube.com' ]]; then
                        youtube-dl -F --no-warnings "$url" | sed '1,4d;/^[sb]/d'
                    else
                        youtube-dl -F --no-warnings "$url"
                    fi

                    __
                    echo -e " ${green}Choose a format code. \n eg: 137+251 for merging, hls-1080p, 22 for single:${nocolor}"
                    read -r code
                    sleep 0.5
                    clear

                    if [[ "$code" =~ '+' ]]; then
                        echo " ${green}Please be patient while downloading and merging formats for:"
                        echo -e " ${red}$(_GetLinkTitle -d).${nocolor}\n"
                        youtube-dl -f --no-warnings "$code" --merge-output-format mp4 --progress "$url"
                    else
                        echo " ${green}Please be patient while downloading:"
                        echo -e " ${red}$(_GetLinkTitle -d).${nocolor}\n"
                        youtube-dl -f --no-warnings "$code" --progress "$url"
                    fi

                    sed -i '2d' "$list"; sed -i '1d' "$tmp_dir"/download.txt
                    clear

                done

                echo " ${green}All done${nocolor}"
                sleep 2
                _DownloadCompleted
        ;;
    esac

}
