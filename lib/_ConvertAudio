#!/bin/bash
## This is a part of main script: mpm.

_ConvertAudio() {

    cd "$audios_dir" || exit 1
    
    __ConversionDone() (
        rm ./*.webm
        echo " ${info}Conversion done.${nc}"
        sleep 2
        return
    )

    __mp3() (
        echo " ${info}Converting files in ${task}${b}mp3${nb}${nc}...${nc}"
        find . -iname "*.webm" -exec \
        bash -c 'FILE="$1"; \
            ffmpeg -i "${FILE}" \
            -vn -ab 320k -ar 48000 \
            -y "${FILE%.webm}.mp3";' _ '{}' \; 2>"$FFOP"
        __ConversionDone
    )

    __flac() (
        echo " ${info}Converting files in ${task}${b}flac${nb}${nc}...${nc}"
        find . -iname "*.webm" -exec \
        bash -c 'FILE="$1"; \
            ffmpeg -i "${FILE}" \
            -af aformat=s32:48000 \
            -y "${FILE%.webm}.flac";' _ '{}' \; 2>"$FFOP"
        __ConversionDone
    )

    __wav() (
        echo " ${info}Converting files in ${task}${b}wav${nb}${nc}...${nc}"
        find . -iname "*.webm" -exec \
        bash -c 'FILE="$1"; \
            ffmpeg -i "${FILE}" \
            -acodec pcm_s32le -ar 48000 \
            -y "${FILE%.webm}.wav";' _ '{}' \; 2>"$FFOP"
        __ConversionDone
    )

    __ogg() (
        echo " ${info}Converting files in ${task}${b}ogg${nb}${nc}...${nc}"
        find . -iname "*.webm" -exec \
        bash -c 'FILE="$1"; \
            ffmpeg -i "${FILE}" \
            -acodec libvorbis -ar 48000 -ab 320k \
            -y "${FILE%.webm}.ogg";' _ '{}' \; 2>"$FFOP"
        __ConversionDone
    )

    __FormatSelection() {
        read -rn1 -p "${info}"' Select an output format [1 = mp3] [2 = flac] [3 = wav] [4 = ogg]: '"${nc}" conv
        __
        case "$conv" in
            1)
                __mp3 ;;
            2)
                __flac ;;
            3)
                __wav ;;
            4)
                __ogg ;;
            *)
                echo " ${critical}UNKNOWN FORMAT !!! Try again.${nc}"
                sleep 3s
                clear
                _Menu
            ;;
        esac
    }

    declare -a FORMATS=( "flac" "mp3" "ogg" "wav" )

    [[ -z $default_conversion_format ]] && {
        printf '%s\n' " ${task}Default format is empty.${nc}"
        __
        __FormatSelection
    }

    # testing if format is set and if it is part of array FORMAT
    # if so we use it for conversion.
    if [[ -n $default_conversion_format ]] && \
        [[ $(echo "${FORMATS[@]}") =~ $default_conversion_format ]]; then
        __
        printf '%s\n' " ${task}Default format set to $default_conversion_format.${nc}"
        __
        __"$default_conversion_format"
    else
        printf '%s\n' " ${critical}Format $default_conversion_format not supported.${nc}"
        __
        __FormatSelection
    fi

}

