#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154,SC2001
_CopyMediaUrl() {

    __isMediaUrlCorrect() (
        [[ -z $mediaUrl || $mediaUrl != https* ]] && {
            printf '' | "${clipboardCmd[0]}" -i
            _CreateAddPlaylist "$arg"
        }
    )
    
    if __clipboardCmdTest; then
        read -r mediaUrl < <("${clipboardCmd[@]}")
        __isMediaUrlCorrect
    else
        __
        echo -e " Paste an url to fill the ${info}${Type}${nc} playlist:\n"
        read -r mediaUrl
        __isMediaUrlCorrect
    fi

    if [[ $mediaUrl =~ 'playlist?list=' ]]; then
        __
        printf '%s\n' " ${info}Getting titles & links from playlist: $(\
        yt-dlp "${ytdlPreset_DW[@]}" -J --flat-playlist "$mediaUrl" \
        | jq --raw-output .title)..." \
        "${b} Please be patient.${nb}${nc}"
        _GetYoutubePlaylistUrls "$arg"
    else
        mediaUrl=$(echo "$mediaUrl" | sed 's/&list=.*//')
        __
        printf '%s\n' " ${info}Testing url...${nc}"
        if [[ ! $(yt-dlp --print formats_table "$mediaUrl") ]]; then
            __
            printf '%s\n' " ${critical}${b}No format code found!${nb}"\
            " $mediaUrl will be removed." \
            " ${info}Please visit: $supportedSites${nc}"
            sleep 7
        else
            echo "$mediaUrl" | tee -a "$URLS" >> "$DEFAULT_LIST"
            echo -e " ${info}Getting ${Type} title...${nc}\n"
            yt-dlp --skip-download --get-title --flat-playlist \
            "${ytdlPreset_DW[@]}" "$mediaUrl" \
            | tee -a "$TITLES" >> "$DEFAULT_TITLES"
            _RemoveCrap
        fi
    fi

}