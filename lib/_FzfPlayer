#!/usr/bin/env bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154,SC2329,SC1090
_FzfPlayer() {

    cd "$tmp_dir" || exit 1

    . "$MPMRC"; . "$THEMERC"

    _ResizeWindow --main

    __passPlaylistIndexToMpv() {
        local line index length
        # There is only one line in this file
        read -r line < playerSelectedFile
        index=${line%% *}
        length="${#index}"
        if (( length == 1 )); then
            index="${index:0:1}"
        elif (( length == 2 )); then
            index="${index:0:2}"
        else
            index="${index:0:3}"
        fi
        echo playlist-play-index "$index" | socat - "${MPVSOCKET}"
    }

    __volume() {
        if command -v pulsemixer &>/dev/null; then
            pulsemixer
        elif command -v ncpamixer &>/dev/null; then
            ncpamixer
        else
            clear
            printf '\n%s\n' " ${critical}Please install pulsemixer or ncpamixer.${nc}"
            sleep 3
        fi
    }

    __getCurrentIndex() {
        if [[ -S "${MPVSOCKET}" ]]; then
            response=$(
                echo '{ "command": ["get_property", "playlist-pos"] }' \
                | socat - "${MPVSOCKET}" 2>/dev/null
            )
            if [[ -n "$response" ]]; then
                current_index=$(echo "$response" | grep -oP '(?<="data":)\d+')
            fi
        fi
        if [[ -z "$current_index" || "$current_index" == "null" ]]; then
            current_index=0
        fi
    }

    export -f __passPlaylistIndexToMpv
    export -f __volume
    export -f __getCurrentIndex
    __getCurrentIndex

    # this function is in ~/.config/mpm/themerc
    _NativePlayerColors "$native_tui_colors"

    declare -a header=(
        "Enter:play," "Left:-30s," "Right:+30s,"
        "^N:next," "^P:prev," "^T:toggle pause,"
        "^R:reload," "^V:volume," "ESC:exit," "^X:quit mpv:"
    )

    fzf \
    --cycle \
    --track \
    --reverse \
    --no-multi \
    --pointer '|>' \
    --scroll-off=5 \
    --no-scrollbar \
    --border rounded \
    --prompt='Search: ' \
    --preview-window=down:1 \
    --preview="(_MpvSocketCommands --title)" \
    --header-first \
    --header "${header[*]}
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    " \
    --bind "load:pos($((current_index + 1)))" \
    --bind "enter:execute(echo {} > playerSelectedFile; __passPlaylistIndexToMpv)+refresh-preview" \
    --bind "left:execute(_MpvSocketCommands --backward)" \
    --bind "right:execute(_MpvSocketCommands --forward)" \
    --bind "ctrl-n:execute(_MpvSocketCommands --next)" \
    --bind "ctrl-p:execute(_MpvSocketCommands --prev)" \
    --bind "ctrl-t:execute(_MpvSocketCommands --pause)" \
    --bind "ctrl-r:execute(_MpvSocketCommands --begin)" \
    --bind "ctrl-v:execute(__volume)" \
    --bind "ctrl-x:execute(_MpvSocketCommands --stop; rm ./playerSelectedFile)+abort" \
    --bind "esc:execute(sed -i '1d' ./playerSelectedFile)+abort" < playerIndexesList

    export FZF_DEFAULT_OPTS=

}
