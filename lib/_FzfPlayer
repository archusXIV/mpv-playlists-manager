#!/bin/bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154,SC2317
_FzfPlayer() {

    cd "$tmp_dir" || exit 1

    __passPlaylistIndexToMpv() (
        local index lenght
        index=$(awk '{print $1}' playerSelectedFile)
        lenght="${#index}"

        if [[ $lenght -eq 1 ]]; then
            index="${index:0:1}"
        elif [[ $lenght -eq 2 ]]; then
            index="${index:0:2}"
        else
            index="${index:0:3}"
        fi
        echo playlist-play-index "$index" | socat - "$MPVSOCKET"
    )

    export -f __passPlaylistIndexToMpv

    # this function is in ~/.config/mpm/themerc
    _NativePlayerColors
    
    while [[ -s playerSelectedFile ]]; do
        fzf \
        --cycle \
        --reverse \
        --no-multi \
        --pointer '|>' \
        --scroll-off=5 \
        --no-scrollbar \
        --border rounded \
        --prompt='Search: ' \
        --preview-window=down:1 \
        --preview="(_MpvSocketCommands --title)" \
        --border-label "| ${mtitle}Native Mpm Player${nc} |" \
        --border-label-pos='101:bottom' \
        --header-first \
        --header '     Enter:play, Left:seek-30s, Right:seek+30s, ^N:next, ^P:prev, ^T:toggle pause, ^R:reload, ESC:quit player.
     ─────────────────────────────────────────────────────────────────────────────────────────────────────────
        ' \
        --bind "enter:become(
            echo {} > playerSelectedFile; __passPlaylistIndexToMpv; _MpvSocketCommands --title
        )" \
        --bind "ctrl-n:become(_MpvSocketCommands --next; _MpvSocketCommands --title)" \
        --bind "ctrl-p:become(_MpvSocketCommands --prev; _MpvSocketCommands --title)" \
        --bind "ctrl-t:become(_MpvSocketCommands --pause)" \
        --bind "ctrl-r:become(_MpvSocketCommands --title)" \
        --bind "left:become(_MpvSocketCommands --backward)" \
        --bind "right:become(_MpvSocketCommands --forward)" \
        --bind "esc:become(sed -i '1d' ./playerSelectedFile)" < playerIndexesList
	done
    export FZF_DEFAULT_OPTS=
}
