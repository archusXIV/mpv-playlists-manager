#!/usr/bin/env bash
## This is a part of main script: mpm.

# shellcheck disable=SC2154
_ParallelAnimation() {

    case "$parallel_animation" in
        spinners)
            local spinners
            spinners="|/-\\"
            while [[ -s $animationTitles ]]; do
                local temp=${spinners#?}
                printf " [${task}%c${nc}]  " "$spinners"
                local spinners=$temp${spinners%"$temp"}
                sleep 0.2
                printf "\b\b\b\b\b\b"
            done
            clear
        ;;
        progress)

            local bar bar_width blocks downloaded empty percent total allowed_ext

            if [[ $type == "audio" ]]; then
                extensions=( "webm" "m4a" )
            else
                extensions=( "mp4" "mkv" )
            fi

            # Build regex pattern from extensions array (e.g., "webm|m4a")
            allowed_ext="${extensions[*]}"
            allowed_ext="${allowed_ext// /|}"

            total=0
            while read -r _; do ((total++)); done < "$animationTitles"
            bar_width=64

            until ((downloaded == total)); do
                downloaded=0
                for file in "$mediaDir"/*; do
                    ext_name="${file##*.}"
                    if [[ -f $file && $ext_name =~ ^($allowed_ext)$ ]]; then
                        ((downloaded++))
                    fi
                done
                # Calculate percentage and blocks with ceiling division
                percent=$(((downloaded * 100 + total - 1) / total))
                blocks=$(((downloaded * bar_width + total - 1) / total))
                # Cap at 100% and full bar width
                ((percent > 100)) && percent=100
                ((blocks > bar_width)) && blocks=$bar_width
                # Build and display progress bar
                empty=$((bar_width - blocks))
                bar=""
                for ((i=0;i<blocks;i++)); do bar+="â–ˆ"; done
                for ((i=0;i<empty;i++)); do bar+="."; done
                printf "\r [%s] %3d%%" "$bar" "$percent"

                sleep 0.5

            done
            clear
        ;;
    esac

}